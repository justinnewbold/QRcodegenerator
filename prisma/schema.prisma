// Prisma Schema for QR Code Generator SaaS Platform

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Authentication & User Management
model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model User {
  id            String    @id @default(cuid())
  name          String?
  email         String?   @unique
  emailVerified DateTime?
  image         String?
  password      String?
  plan          Plan      @default(FREE)
  credits       Int       @default(100)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  accounts          Account[]
  sessions          Session[]
  qrCodes           QRCode[]
  workspaces        WorkspaceMember[]
  ownedWorkspaces   Workspace[]       @relation("WorkspaceOwner")
  apiKeys           ApiKey[]
  campaigns         Campaign[]
  subscriptions     Subscription[]
  activityLogs      ActivityLog[]

  @@index([email])
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

// Workspace & Team Collaboration
model Workspace {
  id          String   @id @default(cuid())
  name        String
  slug        String   @unique
  ownerId     String
  brandKit    Json?    // Colors, logos, fonts
  plan        Plan     @default(FREE)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  owner        User              @relation("WorkspaceOwner", fields: [ownerId], references: [id])
  members      WorkspaceMember[]
  qrCodes      QRCode[]
  campaigns    Campaign[]
  templates    Template[]
  brandKits    BrandKit[]

  @@index([ownerId])
  @@index([slug])
}

model WorkspaceMember {
  id          String        @id @default(cuid())
  workspaceId String
  userId      String
  role        WorkspaceRole @default(VIEWER)
  joinedAt    DateTime      @default(now())

  workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([workspaceId, userId])
  @@index([userId])
  @@index([workspaceId])
}

// QR Code Management
model QRCode {
  id                String    @id @default(cuid())
  userId            String
  workspaceId       String?
  campaignId        String?
  shortId           String    @unique // For URL shortener
  type              QRType
  content           String    @db.Text
  dynamicUrl        String?   // For dynamic QR codes
  name              String?
  description       String?
  customization     Json      // Colors, logo, style settings
  errorCorrection   String    @default("M")
  size              Int       @default(300)
  isDynamic         Boolean   @default(false)
  isActive          Boolean   @default(true)
  expiresAt         DateTime?
  password          String?   // Encrypted
  maxScans          Int?
  metadata          Json?     // Custom metadata
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  user      User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  workspace Workspace? @relation(fields: [workspaceId], references: [id], onDelete: SetNull)
  campaign  Campaign?  @relation(fields: [campaignId], references: [id], onDelete: SetNull)
  scans     Scan[]
  versions  QRVersion[]

  @@index([userId])
  @@index([workspaceId])
  @@index([campaignId])
  @@index([shortId])
  @@index([createdAt])
}

model QRVersion {
  id        String   @id @default(cuid())
  qrCodeId  String
  content   String   @db.Text
  metadata  Json?
  createdAt DateTime @default(now())

  qrCode QRCode @relation(fields: [qrCodeId], references: [id], onDelete: Cascade)

  @@index([qrCodeId])
}

// Analytics & Tracking
model Scan {
  id         String    @id @default(cuid())
  qrCodeId   String
  ipAddress  String?
  userAgent  String?   @db.Text
  country    String?
  city       String?
  latitude   Float?
  longitude  Float?
  device     String?
  os         String?
  browser    String?
  referrer   String?   @db.Text
  language   String?
  scannedAt  DateTime  @default(now())

  qrCode QRCode @relation(fields: [qrCodeId], references: [id], onDelete: Cascade)

  @@index([qrCodeId])
  @@index([scannedAt])
  @@index([country])
}

// Campaign Management
model Campaign {
  id          String    @id @default(cuid())
  userId      String
  workspaceId String?
  name        String
  description String?   @db.Text
  startDate   DateTime?
  endDate     DateTime?
  status      CampaignStatus @default(DRAFT)
  goals       Json?     // Target metrics
  metadata    Json?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  user      User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  workspace Workspace? @relation(fields: [workspaceId], references: [id], onDelete: SetNull)
  qrCodes   QRCode[]

  @@index([userId])
  @@index([workspaceId])
  @@index([status])
}

// Templates & Brand Kits
model Template {
  id          String   @id @default(cuid())
  workspaceId String?
  name        String
  description String?  @db.Text
  category    String
  preview     String?  @db.Text // Base64 preview
  config      Json     // QR configuration
  isPremium   Boolean  @default(false)
  price       Int?     // In cents
  downloads   Int      @default(0)
  rating      Float    @default(0)
  isPublic    Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  workspace Workspace? @relation(fields: [workspaceId], references: [id], onDelete: SetNull)

  @@index([category])
  @@index([isPremium])
  @@index([isPublic])
}

model BrandKit {
  id          String   @id @default(cuid())
  workspaceId String
  name        String
  colors      Json     // Primary, secondary, accent colors
  logo        String?  @db.Text // Base64 or URL
  fonts       Json?
  metadata    Json?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  @@index([workspaceId])
}

// API & Integration
model ApiKey {
  id          String   @id @default(cuid())
  userId      String
  name        String
  key         String   @unique
  lastUsedAt  DateTime?
  expiresAt   DateTime?
  scopes      Json     // Permissions
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())

  user  User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  usage ApiKeyUsage[]

  @@index([userId])
  @@index([key])
}

model ApiKeyUsage {
  id        String   @id @default(cuid())
  apiKeyId  String
  endpoint  String
  requests  Int      @default(0)
  date      DateTime @default(now())

  apiKey ApiKey @relation(fields: [apiKeyId], references: [id], onDelete: Cascade)

  @@unique([apiKeyId, endpoint, date])
  @@index([apiKeyId])
  @@index([date])
}

// Billing & Subscriptions
model Subscription {
  id                String              @id @default(cuid())
  userId            String
  plan              Plan
  status            SubscriptionStatus  @default(ACTIVE)
  stripeCustomerId  String?             @unique
  stripeSubscriptionId String?          @unique
  currentPeriodEnd  DateTime?
  cancelAtPeriodEnd Boolean             @default(false)
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([status])
}

model Payment {
  id              String        @id @default(cuid())
  userId          String
  amount          Int           // In cents
  currency        String        @default("usd")
  status          PaymentStatus @default(PENDING)
  stripePaymentId String?       @unique
  description     String?
  metadata        Json?
  createdAt       DateTime      @default(now())

  @@index([userId])
  @@index([status])
}

// Activity Logs
model ActivityLog {
  id        String   @id @default(cuid())
  userId    String
  action    String
  resource  String
  resourceId String?
  metadata  Json?
  ipAddress String?
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([createdAt])
  @@index([action])
}

// Enums
enum Plan {
  FREE
  PRO
  BUSINESS
  ENTERPRISE
}

enum WorkspaceRole {
  OWNER
  ADMIN
  EDITOR
  VIEWER
}

enum QRType {
  URL
  TEXT
  EMAIL
  PHONE
  SMS
  WIFI
  VCARD
  EVENT
  LOCATION
  CRYPTO
  WHATSAPP
  TELEGRAM
  INSTAGRAM
  TWITTER
  LINKEDIN
  YOUTUBE
  TIKTOK
  PAYMENT
}

enum CampaignStatus {
  DRAFT
  ACTIVE
  PAUSED
  COMPLETED
  ARCHIVED
}

enum SubscriptionStatus {
  ACTIVE
  CANCELED
  PAST_DUE
  TRIALING
  INCOMPLETE
}

enum PaymentStatus {
  PENDING
  SUCCEEDED
  FAILED
  REFUNDED
}
